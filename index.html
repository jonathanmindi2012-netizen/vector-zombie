<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vector Zombie: Nuke Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script><style type="text/css">* {user-select: auto !important; -webkit-user-select: auto !important;}</style><input type="hidden" id="inject_idm_text_selection">
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&amp;display=swap" rel="stylesheet">
    <style>
        html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; background-color: #0d1110; font-family: 'Teko', sans-serif; }
        canvas { display: block; touch-action: none; width: 100%; height: 100%; }
        
        /* Matte/Gritty Style */
        .glass { background: rgba(20, 30, 25, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(100, 255, 150, 0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .glass-low { background: rgba(20, 30, 25, 0.95); border: 1px solid rgba(100, 255, 150, 0.15); } /* No blur for low quality */
        
        .hidden { display: none !important; }
        #ui-layer { pointer-events: none; }
        #ui-layer > * { pointer-events: auto; }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 2px, 0); } 20%, 80% { transform: translate3d(4px, -4px, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 6px, 0); } 40%, 60% { transform: translate3d(6px, -6px, 0); } }
        
        .nuke-shake { animation: nukeShake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes nukeShake { 0% { transform: translate(0,0); } 10%, 90% { transform: translate(-10px, 10px); } 20%, 80% { transform: translate(10px, -10px); } 30%, 50%, 70% { transform: translate(-15px, 15px); } 40%, 60% { transform: translate(15px, -15px); } }

        .damage-flash { animation: flashRed 0.3s ease-out; }
        @keyframes flashRed { 0% { background-color: rgba(180, 20, 20, 0.3); } 100% { background-color: transparent; } }
        
        .nuke-flash { animation: flashWhite 1s ease-out; }
        @keyframes flashWhite { 0% { background-color: rgba(255, 255, 255, 1); } 100% { background-color: transparent; } }

        .btn-press { transition: transform 0.05s, background-color 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .btn-active { background-color: rgba(255, 80, 80, 0.4) !important; border-color: #ff5050 !important; transform: scale(0.95); }
        
        .zombie-pulse { animation: pulse-zombie 4s infinite ease-in-out; }
        @keyframes pulse-zombie { 0%, 100% { filter: grayscale(0.8) brightness(0.8); } 50% { filter: grayscale(0.2) brightness(1.2); } }

        .ult-ready { 
            background-color: rgba(100, 255, 218, 0.2) !important; 
            border-color: #64ffda !important; 
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.3);
            animation: pulse-ult 1s infinite;
        }
        .ult-disabled { opacity: 0.3; filter: grayscale(1); }
        @keyframes pulse-ult { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 12px; border-radius: 2px;
            background: #558844; cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 5px rgba(85, 136, 68, 0.8);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #1a2b15; border: 1px solid #2f4a22;
        }
        input[type=range]:focus { outline: none; }

        /* Scrollbar for Leaderboard */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #558844; border-radius: 2px; }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.pointer-events-auto{pointer-events:auto}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.bottom-0{bottom:0px}.bottom-8{bottom:2rem}.left-0{left:0px}.z-10{z-index:10}.z-50{z-index:50}.z-\[60\]{z-index:60}.mx-4{margin-left:1rem;margin-right:1rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-6{margin-top:1.5rem}.flex{display:flex}.hidden{display:none}.h-16{height:4rem}.h-24{height:6rem}.h-80{height:20rem}.h-full{height:100%}.max-h-60{max-height:15rem}.w-16{width:4rem}.w-24{width:6rem}.w-64{width:16rem}.w-full{width:100%}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.origin-left{transform-origin:left}.scale-x-0{--tw-scale-x:0;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.touch-manipulation{touch-action:manipulation}.select-none{-webkit-user-select:none;user-select:none}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.self-center{align-self:center}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded-full{border-radius:9999px}.rounded-sm{border-radius:0.125rem}.border{border-width:1px}.border-2{border-width:2px}.border-y-4{border-top-width:4px;border-bottom-width:4px}.border-b{border-bottom-width:1px}.border-l-4{border-left-width:4px}.border-r-4{border-right-width:4px}.border-\[\#00ffcc\]{--tw-border-opacity:1;border-color:rgb(0 255 204 / var(--tw-border-opacity, 1))}.border-\[\#558844\]{--tw-border-opacity:1;border-color:rgb(85 136 68 / var(--tw-border-opacity, 1))}.border-\[\#558844\]\/30{border-color:rgb(85 136 68 / 0.3)}.border-\[\#558844\]\/50{border-color:rgb(85 136 68 / 0.5)}.border-\[\#ff4444\]{--tw-border-opacity:1;border-color:rgb(255 68 68 / var(--tw-border-opacity, 1))}.border-\[\#ffaa00\]{--tw-border-opacity:1;border-color:rgb(255 170 0 / var(--tw-border-opacity, 1))}.border-\[\#ffaa00\]\/30{border-color:rgb(255 170 0 / 0.3)}.border-gray-600\/50{border-color:rgb(75 85 99 / 0.5)}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.border-gray-800{--tw-border-opacity:1;border-color:rgb(31 41 55 / var(--tw-border-opacity, 1))}.border-white\/10{border-color:rgb(255 255 255 / 0.1)}.bg-\[\#0d1110\]{--tw-bg-opacity:1;background-color:rgb(13 17 16 / var(--tw-bg-opacity, 1))}.bg-\[\#0d1110\]\/95{background-color:rgb(13 17 16 / 0.95)}.bg-\[\#558844\]{--tw-bg-opacity:1;background-color:rgb(85 136 68 / var(--tw-bg-opacity, 1))}.bg-\[\#558844\]\/20{background-color:rgb(85 136 68 / 0.2)}.bg-\[\#ffaa00\]{--tw-bg-opacity:1;background-color:rgb(255 170 0 / var(--tw-bg-opacity, 1))}.bg-black\/80{background-color:rgb(0 0 0 / 0.8)}.bg-black\/90{background-color:rgb(0 0 0 / 0.9)}.bg-transparent{background-color:transparent}.bg-white\/5{background-color:rgb(255 255 255 / 0.05)}.object-cover{object-fit:cover}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-8{padding:2rem}.px-12{padding-left:3rem;padding-right:3rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pb-2{padding-bottom:0.5rem}.pb-4{padding-bottom:1rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-bold{font-weight:700}.uppercase{text-transform:uppercase}.tracking-\[0\.2em\]{letter-spacing:0.2em}.tracking-tighter{letter-spacing:-0.05em}.tracking-wider{letter-spacing:0.05em}.tracking-widest{letter-spacing:0.1em}.text-\[\#00ffcc\]{--tw-text-opacity:1;color:rgb(0 255 204 / var(--tw-text-opacity, 1))}.text-\[\#0d1110\]{--tw-text-opacity:1;color:rgb(13 17 16 / var(--tw-text-opacity, 1))}.text-\[\#558844\]{--tw-text-opacity:1;color:rgb(85 136 68 / var(--tw-text-opacity, 1))}.text-\[\#558844\]\/80{color:rgb(85 136 68 / 0.8)}.text-\[\#64ffda\]{--tw-text-opacity:1;color:rgb(100 255 218 / var(--tw-text-opacity, 1))}.text-\[\#ff4444\]{--tw-text-opacity:1;color:rgb(255 68 68 / var(--tw-text-opacity, 1))}.text-\[\#ffaa00\]{--tw-text-opacity:1;color:rgb(255 170 0 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.opacity-90{opacity:0.9}.backdrop-blur-md{--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:border-red-500\/50:hover{border-color:rgb(239 68 68 / 0.5)}.hover\:bg-\[\#558844\]\/10:hover{background-color:rgb(85 136 68 / 0.1)}.hover\:bg-\[\#66aa55\]:hover{--tw-bg-opacity:1;background-color:rgb(102 170 85 / var(--tw-bg-opacity, 1))}.hover\:bg-\[\#ffcc00\]:hover{--tw-bg-opacity:1;background-color:rgb(255 204 0 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.hover\:bg-red-900\/30:hover{background-color:rgb(127 29 29 / 0.3)}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.active\:border-\[\#ff5050\]:active{--tw-border-opacity:1;border-color:rgb(255 80 80 / var(--tw-border-opacity, 1))}.active\:bg-\[\#ff5050\]\/20:active{background-color:rgb(255 80 80 / 0.2)}.group:hover .group-hover\:scale-x-100{--tw-scale-x:1;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.group:hover .group-hover\:text-\[\#0d1110\]{--tw-text-opacity:1;color:rgb(13 17 16 / var(--tw-text-opacity, 1))}</style></head>
<body>

<!-- Assets Declaration -->
<div id="assets" style="display: none;">
    <audio id="bgm_main" data-editable="audio" data-label="BGM" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/bgm/0001/Sci-fi/Star-Light_Looping.mp3" preload="auto" loop=""></audio>
    <audio id="sfx_lobby" data-editable="audio" data-label="Lobby Ambience" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky_41.mp3" preload="auto"></audio>
    <audio id="sfx_play" data-editable="audio" data-label="Play Button" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky_42.mp3" preload="auto"></audio>
    <audio id="sfx_hit" data-editable="audio" data-label="Enemy Hit" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/Sci-fi/Space-Cannon.mp3" preload="auto"></audio>
    <audio id="sfx_shoot" data-editable="audio" data-label="Shoot SFX" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/Sci-fi/PowerRez12.mp3" preload="auto"></audio>
    <audio id="sfx_player_hit" data-editable="audio" data-label="Player Hit" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/Creepy/Creepy_Percussion_1.mp3" preload="auto"></audio>
    <audio id="sfx_beam" data-editable="audio" data-label="Beam Ability" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/Sci-fi/Laser-Shot-1.mp3" preload="auto"></audio>
    <audio id="sfx_bomb" data-editable="audio" data-label="Bomb Explosion" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/Combat/Clank_3.mp3" preload="auto"></audio>
    <audio id="sfx_ui_click" data-editable="audio" data-label="UI Click" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky_46.mp3" preload="auto"></audio>
    <audio id="sfx_ui_toggle" data-editable="audio" data-label="UI Toggle" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky_41.mp3" preload="auto"></audio>
    <audio id="sfx_rank" data-editable="audio" data-label="Rank Display" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky32.mp3" preload="auto"></audio>
    
    <img id="img_human_cover" data-editable="image" data-label="Cover Art" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMzAwIj4KICA8cmVjdCB3aWR0PSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMwZDExMTAiIC8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTUwIiByPSI2MCIgZmlsbD0iIzU1ODg0NCIgc3Ryb2tlPSIjMmY0YTIyIiBzdHJva2Utd2lkdGg9IjQiIC8+CiAgPGNpcmNsZSBjeD0iODAiIGN5PSIxNDAiIHI9IjEwIiBmaWxsPSIjMDAwIiAvPgogIDxjaXJjbGUgY3g9IjEyMCIgY3k9IjE0NSIgcj0iOCIgZmlsbD0iIzAwMCIgLz4KICA8cGF0aCBkPSJNIDgwIDE4MCBRIDEwMCAyMDAgMTIwIDE4MCIgc3Ryb2tlPSIjMmY0YTIyIiBzdHJva2Utd2lkdGg9IjUiIGZpbGw9Im5vbmUiIC8+CiAgPHBhdGggZD0iTSAwIDAgTCAyMDAgMzAwIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIgc3Ryb2tlLXdpZHRoPSIyIiAvPgo8L3N2Zz4=" hidden="">
</div>

<!-- Configuration -->
<script id="game-config" type="application/x-game-config">
{
    "playerSpeed": { "type": "number", "label": "Move Speed", "value": 180, "min": 100, "max": 400 },
    "enemySpeed": { "type": "number", "label": "Zombie Speed", "value": 45, "min": 10, "max": 150 },
    "spawnRate": { "type": "number", "label": "Spawn Rate (ms)", "value": 700, "min": 200, "max": 2000 },
    "themeColor": { "type": "color", "label": "Theme Color", "value": "#00ffcc" }
}
</script>

<!-- Game Container -->
<div id="game-container" class="relative w-full h-full select-none bg-[#0d1110]" style="filter: brightness(100%);">
    <canvas id="gameCanvas" width="720" height="1192" style="width: 360px; height: 596px;"></canvas>
    
    <!-- UI Layer -->
    <div id="ui-layer" class="absolute inset-0 z-50 flex flex-col justify-between">
        
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0d1110]/95 backdrop-blur-sm pointer-events-auto z-50">
            <div class="relative w-64 h-80 mb-4 border border-[#558844]/30 p-2 glass">
                <img id="lobby-cover-display" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMzAwIj4KICA8cmVjdCB3aWR0PSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMwZDExMTAiIC8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTUwIiByPSI2MCIgZmlsbD0iIzU1ODg0NCIgc3Ryb2tlPSIjMmY0YTIyIiBzdHJva2Utd2lkdGg9IjQiIC8+CiAgPGNpcmNsZSBjeD0iODAiIGN5PSIxNDAiIHI9IjEwIiBmaWxsPSIjMDAwIiAvPgogIDxjaXJjbGUgY3g9IjEyMCIgY3k9IjE0NSIgcj0iOCIgZmlsbD0iIzAwMCIgLz4KICA8cGF0aCBkPSJNIDgwIDE4MCBRIDEwMCAyMDAgMTIwIDE4MCIgc3Ryb2tlPSIjMmY0YTIyIiBzdHJva2Utd2lkdGg9IjUiIGZpbGw9Im5vbmUiIC8+CiAgPHBhdGggZD0iTSAwIDAgTCAyMDAgMzAwIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIgc3Ryb2tlLXdpZHRoPSIyIiAvPgo8L3N2Zz4=" class="w-full h-full object-cover zombie-pulse opacity-90 rounded-sm">
                <div class="absolute bottom-0 left-0 w-full bg-black/80 text-center py-3">
                    <h1 class="text-3xl font-bold text-white tracking-widest text-[#558844]">VECTOR ZOMBIE</h1>
                </div>
            </div>
            
            <button id="play-btn" class="btn-press group relative px-12 py-3 mb-6 bg-transparent border-2 border-[#558844] text-[#558844] font-bold text-4xl tracking-[0.2em] overflow-hidden rounded-sm">
                <span class="relative z-10 group-hover:text-[#0d1110] transition-colors">SURVIVE</span>
                <div class="absolute inset-0 bg-[#558844] transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
            </button>

            <!-- Menu Buttons Row -->
            <div class="flex gap-4">
                <button id="settings-btn" class="btn-press px-6 py-2 border border-[#558844]/50 text-[#558844]/80 font-bold text-xl tracking-widest hover:bg-[#558844]/10 rounded-sm">
                    SETTINGS
                </button>
                <button id="ranking-btn" class="btn-press px-6 py-2 border border-[#558844]/50 text-[#558844]/80 font-bold text-xl tracking-widest hover:bg-[#558844]/10 rounded-sm">
                    RANKING
                </button>
            </div>
            
            <p class="mt-6 text-gray-500 text-sm tracking-widest font-mono">ONE SHOT. ONE KILL.</p>
        </div>

        <!-- Ranking Modal -->
        <div id="ranking-modal" class="absolute inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md hidden pointer-events-auto z-[60]">
            <div class="glass p-8 w-full max-w-sm border-l-4 border-[#ffaa00]">
                <h2 class="text-3xl text-[#ffaa00] font-bold mb-6 tracking-[0.2em] border-b border-[#ffaa00]/30 pb-2">ELITE SQUAD</h2>
                
                <div class="flex justify-between text-gray-500 text-sm mb-2 px-2 font-mono tracking-widest">
                    <span>OPERATIVE</span>
                    <span>CONFIRMED KILLS</span>
                </div>

                <div id="ranking-list" class="flex flex-col gap-2 mb-8 max-h-60 overflow-y-auto custom-scroll">
                    <!-- JS Generated Content -->
                </div>

                <button id="ranking-close" class="btn-press w-full bg-[#ffaa00] text-[#0d1110] font-bold py-3 text-2xl tracking-widest hover:bg-[#ffcc00]">
                    CLOSE
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
      <div id="settings-modal" class="absolute inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md hidden pointer-events-auto z-[60]">
            <div class="glass p-8 w-full max-w-sm border-l-4 border-[#558844]">
                <h2 class="text-3xl text-[#558844] font-bold mb-6 tracking-[0.2em] border-b border-[#558844]/30 pb-2">SYSTEM CONFIG</h2>
                
                <!-- Brightness -->
                <div class="mb-6">
                    <div class="flex justify-between text-gray-400 text-lg mb-1 tracking-wider">
                        <span>BRIGHTNESS</span>
                        <span id="val-brightness">100%</span>
                    </div>
                    <input type="range" id="input-brightness" min="50" max="150" value="100" step="5">
                </div>

                <!-- Sensitivity -->
                <div class="mb-6">
                    <div class="flex justify-between text-gray-400 text-lg mb-1 tracking-wider">
                        <span>SENSITIVITY</span>
                        <span id="val-sensitivity">1.0x</span>
                    </div>
                    <input type="range" id="input-sensitivity" min="0.5" max="2.0" value="1.0" step="0.1">
                </div>

                <!-- Quality -->
                <div class="mb-8">
                    <div class="flex justify-between text-gray-400 text-lg mb-2 tracking-wider">
                        <span>QUALITY</span>
                        <span id="val-quality" class="text-[#558844]">HIGH</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="quality-low" class="flex-1 py-2 border border-gray-700 text-gray-500 font-bold tracking-widest hover:bg-gray-800">LOW</button>
                        <button id="quality-high" class="flex-1 py-2 border border-[#558844] bg-[#558844]/20 text-[#558844] font-bold tracking-widest">HIGH</button>
                    </div>
                </div>

                <button id="settings-close" class="btn-press w-full bg-[#558844] text-[#0d1110] font-bold py-3 text-2xl tracking-widest hover:bg-[#66aa55]">
                    CONFIRM
                </button>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="flex flex-col w-full p-4 pointer-events-none hidden gap-2">
            <div class="flex justify-between items-start w-full relative">
                <!-- Kills -->
                <div class="glass px-4 py-2 rounded-sm text-white font-bold text-2xl tracking-widest border-l-4 border-[#00ffcc]">
                    KILLS <span id="score-display" class="text-[#00ffcc]">0</span>
                </div>

              <!-- Abort Button -->
                <button id="exit-btn" class="btn-press pointer-events-auto glass px-6 py-2 rounded-sm text-gray-400 hover:text-white font-bold tracking-widest border border-gray-600/50 hover:bg-red-900/30 hover:border-red-500/50 transition-all text-xl">
                    ABORT
                </button>

                <!-- HP -->
                <div class="glass px-4 py-2 rounded-sm text-[#ff4444] font-bold text-2xl tracking-widest border-r-4 border-[#ff4444]">
                    HP <span id="lives-display">100</span>%
                </div>
            </div>
            <!-- Nuke Indicator -->
            <div class="glass self-center px-6 py-1 rounded-full border border-[#ffaa00]/30">
                <span class="text-[#ffaa00] font-bold tracking-[0.2em] text-sm">NUKE PROTOCOL: <span id="nuke-counter" class="text-white">0</span>/10</span>
            </div>
        </div>

        <!-- Controls -->
        <div id="controls" class="absolute bottom-8 w-full left-0 px-8 flex justify-between items-end pointer-events-none hidden">
            <div class="flex flex-col gap-4 items-center">
                <!-- Ult Button -->
                <button id="ult-btn" class="btn-press pointer-events-auto w-16 h-16 rounded-full border-2 border-white/10 bg-white/5 backdrop-blur-sm flex items-center justify-center text-[#64ffda] font-bold text-lg tracking-wider touch-manipulation ult-disabled">
                    BEAM
                </button>
                <!-- Shoot Button (LEFT) -->
                <button id="shoot-btn" class="btn-press pointer-events-auto w-24 h-24 rounded-full border-2 border-white/10 bg-white/5 backdrop-blur-sm flex items-center justify-center text-white font-bold text-xl tracking-widest touch-manipulation active:bg-[#ff5050]/20 active:border-[#ff5050]">
                    FIRE
                </button>
            </div>

            <!-- Joystick Placeholder (RIGHT) -->
            <div class="w-24 h-24 pointer-events-none"></div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="absolute inset-0 flex items-center justify-center bg-[#0d1110]/95 backdrop-blur-md hidden pointer-events-auto">
            <div class="glass p-8 border-y-4 border-[#ff4444] text-center w-full max-w-md mx-4">
                <h1 class="text-6xl font-bold text-[#ff4444] mb-2 tracking-tighter uppercase">KILLED</h1>
                <p class="text-xl text-gray-500 mb-6 tracking-widest font-mono">SIGNAL LOST</p>
                <div class="text-4xl text-white font-bold mb-8 border-b border-gray-800 pb-4">KILLS: <span id="final-score">0</span></div>
                <button id="restart-btn" class="btn-press w-full bg-[#558844] hover:bg-white text-[#0d1110] font-bold py-4 text-2xl uppercase tracking-widest">
                    RESPAWN
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/** 
 * ยง L0 System Invariants 
 */
const CONFIG = {
    dpr: window.devicePixelRatio || 1,
    width: 0,
    height: 0,
    cx: 0,
    cy: 0,
    joystickBase: { x: 0, y: 0, r: 60 }
};

const USER_SETTINGS = {
    brightness: 100,
    sensitivity: 1.0,
    quality: 'HIGH' // 'LOW' | 'HIGH'
};

const HIGH_SCORE_KEY = 'vector_zombie_highscore';

let gameState = 'INIT';
let lastTime = 0;
let score = 0;
let lives = 100;
let gameConfig = {};
let initialized = false;

// Entities
  const entities = {
    player: null,
    enemies: [],
    bullets: [],
    beams: [],
    particles: [],
    grenades: []
};

// Input State
const input = {
    joystick: {
        active: false,
        id: null,
        startX: 0,
        startY: 0,
        currX: 0,
        currY: 0,
        dx: 0,
        dy: 0
    },
    shoot: {
        active: false
    }
};

/**
 * ยง Audio System (Zero DOM Overhead)
 */
const audioSys = {
    ctx: null,
    buffers: {},
    
    init() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        
        ['sfx_hit', 'sfx_player_hit', 'sfx_shoot', 'sfx_lobby', 'sfx_play', 'sfx_beam', 'sfx_bomb', 'sfx_ui_click', 'sfx_ui_toggle', 'sfx_rank'].forEach(id => {
            const el = document.getElementById(id);
            if (el && el.src) {
                fetch(el.src)
                    .then(r => r.arrayBuffer())
                    .then(data => this.ctx.decodeAudioData(data))
                    .then(buffer => { this.buffers[id] = buffer; })
                    .catch(e => console.warn('Audio load fail', id));
            }
        });
    },

    unlock() {
        if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
    },

    playBGM() {
        const bgm = document.getElementById('bgm_main');
        if (bgm && bgm.paused) {
            bgm.volume = 0.4;
            bgm.play().catch(() => {});
        }
    },

    playSfx(id) {
        if (!this.ctx) return;
        const buffer = this.buffers[id];
        if (buffer) {
            const source = this.ctx.createBufferSource();
            source.buffer = buffer;
            source.connect(this.ctx.destination);
            // Random pitch for variety
            source.playbackRate.value = 0.9 + Math.random() * 0.2;
            source.start(0);
        } else {
            this.synthesize(id);
        }
    },

    synthesize(type) {
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        if (type === 'sfx_shoot') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, t);
            osc.frequency.exponentialRampToValueAtTime(50, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(t);
            osc.stop(t + 0.1);
        } else if (type === 'sfx_bomb') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.exponentialRampToValueAtTime(10, t + 0.5);
            gain.gain.setValueAtTime(0.5, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            osc.start(t);
            osc.stop(t + 0.5);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.exponentialRampToValueAtTime(20, t + 0.15);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.15);
            osc.start(t);
            osc.stop(t + 0.15);
        }
    }
};

const vibrate = (type) => {
    if (window.webkit?.messageHandlers?.rezonaBridge) {
        window.webkit.messageHandlers.rezonaBridge.postMessage({
            action: 'vibrate', requestId: 'h5-' + Date.now(), version: '1.0', params: { style: type }
        });
    } else if (navigator.vibrate) {
        navigator.vibrate(type === 'heavy' ? 200 : (type === 'medium' ? 50 : 15));
    }
};

/**
 * ยง Game Logic
 */
class Player {
    constructor() {
        this.x = CONFIG.cx;
        this.y = CONFIG.cy;
        this.radius = 16;
        this.shootTimer = 0;
        this.shootInterval = 0.15;
        this.angle = -Math.PI / 2;
        this.ultCharge = 0; // Max 5
        this.bombStreak = 0; // Max 10
    }

    update(dt) {
        if (input.joystick.active) {
            // Apply Sensitivity Setting
            const speed = gameConfig.playerSpeed * USER_SETTINGS.sensitivity;
            this.x += input.joystick.dx * speed * dt;
            this.y += input.joystick.dy * speed * dt;
            
            this.x = Math.max(this.radius, Math.min(CONFIG.width - this.radius, this.x));
            this.y = Math.max(this.radius, Math.min(CONFIG.height - this.radius, this.y));
            
            if (Math.abs(input.joystick.dx) > 0.1 || Math.abs(input.joystick.dy) > 0.1) {
                this.angle = Math.atan2(input.joystick.dy, input.joystick.dx);
            }
        }

        this.shootTimer -= dt;
        if (input.shoot.active && this.shootTimer <= 0) {
            this.shoot();
            this.shootTimer = this.shootInterval;
        }
    }

    shoot() {
       entities.bullets.push(new Bullet(this.x, this.y, this.angle));
        audioSys.playSfx('sfx_shoot');
        vibrate('light');
        this.x -= Math.cos(this.angle) * 3;
        this.y -= Math.sin(this.angle) * 3;
    }

    fireBeam() {
        if (this.ultCharge < 5) return;
        
        entities.beams.push(new Beam(this.x, this.y, this.angle));
        audioSys.playSfx('sfx_beam');
        vibrate('heavy');
        
        this.ultCharge = 0;
        updateUltUI();
        
        const container = document.getElementById('game-container');
        container.classList.remove('damage-flash');
        void container.offsetWidth;
        container.classList.add('damage-flash');
    }

    throwBomb() {
        this.bombStreak = 0;
        updateNukeUI();
        entities.grenades.push(new Grenade(this.x, this.y));
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);

        // Flashlight cone (Only in High Quality)
        if (USER_SETTINGS.quality === 'HIGH') {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, 200, -0.3, 0.3);
            ctx.fill();
        }

        // Body
        ctx.fillStyle = '#ccc';
        ctx.beginPath();
        ctx.arc(0, 0, this.radius, 0, Math.PI*2);
        ctx.fill();

        // Weapon
        ctx.fillStyle = gameConfig.themeColor;
        ctx.fillRect(5, -4, 18, 8);

        // Helmet/Visor
        ctx.fillStyle = '#111';
        ctx.beginPath();
        ctx.arc(2, 0, this.radius * 0.6, 0, Math.PI*2);
        ctx.fill();

        ctx.restore();
    }
}

class Bullet {
    constructor(x, y, angle) {
        this.x = x;
        this.y = y;
        this.vx = Math.cos(angle) * 800;
        this.vy = Math.sin(angle) * 800;
        this.life = 1.0;
    }
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        this.life -= dt;
    }
    draw(ctx) {
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = gameConfig.themeColor;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x - this.vx * 0.03, this.y - this.vy * 0.03);
        ctx.stroke();
    }
}

class Beam {
    constructor(x, y, angle) {
        this.x = x;
        this.y = y;
        this.angle = angle;
        this.life = 0.5;
        this.maxLife = 0.5;
        this.length = Math.max(CONFIG.width, CONFIG.height) * 1.5;
        this.checkCollisions();
    }

    checkCollisions() {
        const dx = Math.cos(this.angle);
        const dy = Math.sin(this.angle);
        
        entities.enemies.forEach(e => {
            if (e.hp <= 0) return;
            const vx = e.x - this.x;
            const vy = e.y - this.y;
            const t = vx * dx + vy * dy;
            if (t > 0 && t < this.length) {
                const cx = this.x + dx * t;
                const cy = this.y + dy * t;
                const distSq = (e.x - cx)**2 + (e.y - cy)**2;
                if (distSq < (e.radius + 20)**2) {
                    e.die('beam');
                }
            }
        });
    }

    update(dt) {
        this.life -= dt;
    }

    draw(ctx) {
      ctx.save();
        const alpha = this.life / this.maxLife;
        ctx.globalAlpha = alpha;
        
        const ex = this.x + Math.cos(this.angle) * this.length;
        const ey = this.y + Math.sin(this.angle) * this.length;

        ctx.strokeStyle = `rgba(100, 255, 218, ${alpha * 0.5})`;
        ctx.lineWidth = 30;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(ex, ey);
        ctx.stroke();

        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(ex, ey);
        ctx.stroke();
        
        ctx.restore();
    }
}

class Grenade {
    constructor(startX, startY) {
        this.x = startX;
        this.y = startY;
        this.startX = startX;
        this.startY = startY;
        this.targetX = CONFIG.width / 2;
        this.targetY = CONFIG.height / 2;
        this.timer = 0;
        this.duration = 0.8;
        this.height = 0;
    }

    update(dt) {
        this.timer += dt;
        const t = Math.min(this.timer / this.duration, 1);
        
        // Linear move
        this.x = this.startX + (this.targetX - this.startX) * t;
        this.y = this.startY + (this.targetY - this.startY) * t;
        
        // Parabola
        this.height = Math.sin(t * Math.PI) * 150;

        if (t >= 1) {
            this.explode();
        }
    }

    explode() {
        this.timer = 999; // Mark for deletion
        
        // Visuals
        const container = document.getElementById('game-container');
        container.classList.remove('nuke-flash');
        void container.offsetWidth;
        container.classList.add('nuke-flash');
        
        document.body.classList.add('nuke-shake');
        setTimeout(() => document.body.classList.remove('nuke-shake'), 800);
        
        audioSys.playSfx('sfx_bomb');
        vibrate('heavy');

        // Logic: Kill All
        entities.enemies.forEach(e => {
            if (e.hp > 0) e.die('nuke');
        });

        // Particles
        const pCount = USER_SETTINGS.quality === 'HIGH' ? 30 : 10;
        for(let i=0; i<pCount; i++) {
            entities.particles.push(new Particle(this.x, this.y, '#ffaa00'));
        }
    }

    draw(ctx) {
      if (this.timer >= 999) return;
        
        ctx.save();
        ctx.translate(this.x, this.y - this.height);
        
        // Shadow on ground
        if (USER_SETTINGS.quality === 'HIGH') {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(0, this.height + 10, 10, 5, 0, 0, Math.PI*2);
            ctx.fill();
        }

        // Bomb body
        ctx.fillStyle = '#ffaa00';
        ctx.beginPath();
        ctx.arc(0, 0, 8, 0, Math.PI*2);
        ctx.fill();
        
        // Spin
        ctx.rotate(this.timer * 10);
        ctx.fillStyle = '#fff';
        ctx.fillRect(-4, -4, 8, 8);

        ctx.restore();
    }
}

class Zombie {
    constructor() {
        const side = Math.floor(Math.random() * 4);
        if (side === 0) { this.x = Math.random() * CONFIG.width; this.y = -50; }
        else if (side === 1) { this.x = CONFIG.width + 50; this.y = Math.random() * CONFIG.height; }
        else if (side === 2) { this.x = Math.random() * CONFIG.width; this.y = CONFIG.height + 50; }
        else { this.x = -50; this.y = Math.random() * CONFIG.height; }

        this.hp = 1; // ONE SHOT KILL
        this.radius = 18;
        this.speed = gameConfig.enemySpeed * (0.8 + Math.random() * 0.4);
        this.flash = 0;
        this.wobblePhase = Math.random() * Math.PI * 2;
    }

    update(dt) {
        if (!entities.player) return;

        const dx = entities.player.x - this.x;
        const dy = entities.player.y - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        this.wobblePhase += dt * 5;
        const wobble = Math.sin(this.wobblePhase) * 15;

        if (dist > 0) {
            const nx = dx / dist;
            const ny = dy / dist;
            this.x += (nx * this.speed + -ny * wobble) * dt;
            this.y += (ny * this.speed + nx * wobble) * dt;
        }

        if (dist < this.radius + entities.player.radius) {
            this.hitPlayer();
        }

        if (this.flash > 0) this.flash -= dt;
    }

    hitPlayer() {
          lives -= 15;
        updateHUD();
        vibrate('medium');
        audioSys.playSfx('sfx_player_hit');
        
        const container = document.getElementById('game-container');
        container.classList.remove('damage-flash');
        void container.offsetWidth;
        container.classList.add('damage-flash');
        
        document.body.classList.add('shake');
        setTimeout(() => document.body.classList.remove('shake'), 400);

        this.die('suicide');
        if (lives <= 0) setState('GAMEOVER');
    }

    takeDamage() {
        this.die('bullet');
    }

    die(cause) {
        if (this.hp <= 0) return;
        this.hp = 0;
        
        if (cause !== 'suicide') {
            score += 1;
            vibrate('medium');
            audioSys.playSfx('sfx_hit'); 

            if (entities.player) {
                // Beam Charge
                if (entities.player.ultCharge < 5) {
                    entities.player.ultCharge++;
                    updateUltUI();
                }
                // Nuke Charge
                if (cause === 'bullet' || cause === 'beam') {
                    entities.player.bombStreak++;
                    updateNukeUI();
                    if (entities.player.bombStreak >= 10) {
                        entities.player.throwBomb();
                    }
                }
            }
            updateHUD();
        }
        
        const pCount = USER_SETTINGS.quality === 'HIGH' ? 6 : 3;
        for(let i=0; i<pCount; i++) {
            entities.particles.push(new Particle(this.x, this.y, '#3a5c3a'));
        }
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        
        // Shadow
        if (USER_SETTINGS.quality === 'HIGH') {
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.beginPath();
            ctx.ellipse(0, 8, this.radius, this.radius*0.6, 0, 0, Math.PI*2);
            ctx.fill();
        }

        if (this.flash > 0) {
              ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI*2);
            ctx.fill();
        } else {
            ctx.fillStyle = '#558844';
            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI*2);
            ctx.fill();
            
            ctx.strokeStyle = '#2f4a22';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = '#1a2b15';
            ctx.beginPath();
            ctx.arc(-6, -4, 4, 0, Math.PI*2);
            ctx.arc(6, -4, 4, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.color = color;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 100 + 50;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.life = 0.5 + Math.random() * 0.5;
        this.size = 3 + Math.random() * 4;
    }
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        this.life -= dt;
        this.vx *= 0.9;
        this.vy *= 0.9;
    }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

/**
 * ยง Lifecycle
 */
function initGame() {
    if (initialized) return;
    
    try {
        const cfg = JSON.parse(document.getElementById('game-config').textContent);
        for (let k in cfg) gameConfig[k] = cfg[k].value;
    } catch(e) {
        gameConfig = { playerSpeed: 180, enemySpeed: 45, spawnRate: 700, themeColor: '#00ffcc' };
    }

    const coverImg = document.getElementById('img_human_cover');
    const lobbyDisplay = document.getElementById('lobby-cover-display');
    if (coverImg && lobbyDisplay) lobbyDisplay.src = coverImg.src;

    entities.player = new Player();
    audioSys.init();
    
    // Apply default settings
    updateSettingsUI();
    
    setState('LOBBY');
    
    lastTime = performance.now();
    requestAnimationFrame(loop);
    initialized = true;
}

function restartGame() {
    score = 0;
    lives = 100;
    entities.enemies = [];
    entities.bullets = [];
    entities.beams = [];
    entities.particles = [];
    entities.grenades = [];
    entities.player = new Player();
    updateHUD();
    updateUltUI();
    updateNukeUI();
    setState('PLAYING');
}

function updateUltUI() {
    const btn = document.getElementById('ult-btn');
    if (entities.player && entities.player.ultCharge >= 5) {
        btn.classList.remove('ult-disabled');
        btn.classList.add('ult-ready');
        btn.innerText = "BEAM READY";
    } else {
        btn.classList.add('ult-disabled');
        btn.classList.remove('ult-ready');
        btn.innerText = `${entities.player ? entities.player.ultCharge : 0}/5`;
    }
}

function updateNukeUI() {
    const el = document.getElementById('nuke-counter');
    if (entities.player && el) {
        el.innerText = entities.player.bombStreak;
    }
}

function updateRankingList() {
     const list = document.getElementById('ranking-list');
    list.innerHTML = '';
    
    // Get stored high score
    const storedScore = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
    
    // Mock Data + Player Score
    const data = [
        { name: 'UNIT 734', score: 2450, bot: true },
        { name: 'SGT. DOOM', score: 1890, bot: true },
        { name: 'CPL. HICKS', score: 850, bot: true },
        { name: 'PVT. JOE', score: 420, bot: true },
        { name: 'YOU', score: storedScore, bot: false }
    ];
    
    // Sort descending
    data.sort((a, b) => b.score - a.score);
    
    // Render
    data.forEach((entry, idx) => {
        const row = document.createElement('div');
        row.className = `flex justify-between items-center p-3 border-b border-gray-800 ${entry.bot ? 'text-gray-400' : 'bg-[#ffaa00]/10 text-[#ffaa00] font-bold'}`;
        
        row.innerHTML = `
            <div class="flex gap-3 items-center">
                <span class="text-xs opacity-50 font-mono w-4">${idx + 1}.</span>
                <span class="tracking-wider">${entry.name}</span>
            </div>
            <span class="font-mono text-lg">${entry.score}</span>
        `;
        list.appendChild(row);
    });
}

function setState(newState) {
    gameState = newState;
    const lobby = document.getElementById('lobby-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const hud = document.getElementById('hud');
    const controls = document.getElementById('controls');
    const settingsModal = document.getElementById('settings-modal');
    const rankingModal = document.getElementById('ranking-modal');
    
    lobby.classList.add('hidden');
    gameOverScreen.classList.add('hidden');
    hud.classList.add('hidden');
    controls.classList.add('hidden');
    settingsModal.classList.add('hidden');
    rankingModal.classList.add('hidden');

    if (newState === 'LOBBY') {
        lobby.classList.remove('hidden');
        audioSys.playSfx('sfx_lobby');
    } else if (newState === 'SETTINGS') {
        lobby.classList.remove('hidden'); 
        settingsModal.classList.remove('hidden');
    } else if (newState === 'RANKING') {
        lobby.classList.remove('hidden');
        updateRankingList();
        rankingModal.classList.remove('hidden');
        audioSys.playSfx('sfx_rank');
    } else if (newState === 'PLAYING') {
        hud.classList.remove('hidden');
        controls.classList.remove('hidden');
        audioSys.playBGM();
        updateUltUI();
        updateNukeUI();
    } else if (newState === 'GAMEOVER') {
        // Save High Score
        const currentHigh = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
        if (score > currentHigh) {
            localStorage.setItem(HIGH_SCORE_KEY, score);
        }
        
        document.getElementById('final-score').innerText = score;
        gameOverScreen.classList.remove('hidden');
    }
}

function updateHUD() {
    document.getElementById('score-display').innerText = score;
    const l = document.getElementById('lives-display');
    l.innerText = Math.max(0, lives);
    l.parentElement.style.color = lives < 30 ? '#ff4444' : '#ff4444';
}

function updateSettingsUI() {
    // Update DOM from State
    document.getElementById('input-brightness').value = USER_SETTINGS.brightness;
    document.getElementById('val-brightness').innerText = USER_SETTINGS.brightness + '%';
    
    document.getElementById('input-sensitivity').value = USER_SETTINGS.sensitivity;
    document.getElementById('val-sensitivity').innerText = USER_SETTINGS.sensitivity.toFixed(1) + 'x';
    
    document.getElementById('val-quality').innerText = USER_SETTINGS.quality;
    
    const qLow = document.getElementById('quality-low');
    const qHigh = document.getElementById('quality-high');
    
    if (USER_SETTINGS.quality === 'HIGH') {
        qHigh.classList.add('bg-[#558844]/20', 'text-[#558844]', 'border-[#558844]');
        qHigh.classList.remove('border-gray-700', 'text-gray-500');
        qLow.classList.remove('bg-[#558844]/20', 'text-[#558844]', 'border-[#558844]');
        qLow.classList.add('border-gray-700', 'text-gray-500');
    } else {
        qLow.classList.add('bg-[#558844]/20', 'text-[#558844]', 'border-[#558844]');
        qLow.classList.remove('border-gray-700', 'text-gray-500');
        qHigh.classList.remove('bg-[#558844]/20', 'text-[#558844]', 'border-[#558844]');
        qHigh.classList.add('border-gray-700', 'text-gray-500');
    }

    // Apply Effects
  document.getElementById('game-container').style.filter = `brightness(${USER_SETTINGS.brightness}%)`;
    
    // Toggle Glass Effect
    const glasses = document.querySelectorAll('.glass, .glass-low');
    glasses.forEach(el => {
        if (USER_SETTINGS.quality === 'LOW') {
            el.classList.remove('glass');
            el.classList.add('glass-low');
        } else {
            el.classList.remove('glass-low');
            el.classList.add('glass');
        }
    });

    // Update DPR if needed
    const targetDPR = USER_SETTINGS.quality === 'HIGH' ? (window.devicePixelRatio || 1) : 1;
    if (CONFIG.dpr !== targetDPR) {
        CONFIG.dpr = targetDPR;
        resize(); // Trigger canvas resize
    }
}

let spawnerTimer = 0;

function loop(timestamp) {
    requestAnimationFrame(loop);
    const dt = Math.min((timestamp - lastTime) / 1000, 0.05);
    lastTime = timestamp;

    entities.particles.forEach(p => p.update(dt));
    entities.particles = entities.particles.filter(p => p.life > 0);

    if (gameState === 'LOBBY' || gameState === 'SETTINGS' || gameState === 'RANKING') {
        if (Math.random() < 0.05 && USER_SETTINGS.quality === 'HIGH') {
            entities.particles.push(new Particle(
                Math.random() * CONFIG.width,
                Math.random() * CONFIG.height,
                'rgba(85, 136, 68, 0.2)'
            ));
        }
        draw();
        return;
    }

    if (gameState !== 'PLAYING') {
        draw();
        return;
    }

    spawnerTimer -= dt * 1000;
    if (spawnerTimer <= 0) {
        entities.enemies.push(new Zombie());
        spawnerTimer = gameConfig.spawnRate;
    }

    if (entities.player) entities.player.update(dt);
    
    entities.grenades.forEach(g => g.update(dt));
    entities.grenades = entities.grenades.filter(g => g.timer < 999);
    
    entities.bullets.forEach(b => b.update(dt));
    entities.beams.forEach(b => b.update(dt));
    entities.enemies.forEach(e => e.update(dt));

    // Collisions
    for (let b of entities.bullets) {
        if (b.life <= 0) continue;
        for (let e of entities.enemies) {
            if (e.hp <= 0) continue;
            const dx = b.x - e.x;
            const dy = b.y - e.y;
            if (dx*dx + dy*dy < e.radius * e.radius) {
                b.life = 0;
                e.takeDamage();
                break;
            }
        }
    }

    entities.bullets = entities.bullets.filter(b => b.life > 0 && b.x > 0 && b.x < CONFIG.width && b.y > 0 && b.y < CONFIG.height);
    entities.beams = entities.beams.filter(b => b.life > 0);
    entities.enemies = entities.enemies.filter(e => e.hp > 0);

    draw();
}

function draw() {
     const ctx = canvas.getContext('2d');
    
    // Background
    ctx.fillStyle = '#0d1110';
    ctx.fillRect(0, 0, CONFIG.width, CONFIG.height);

    // Grunge Grid
    ctx.strokeStyle = '#1a2b15';
    ctx.lineWidth = 1;
    ctx.globalAlpha = 0.1;
    const gridSize = 60;
    ctx.beginPath();
    for (let x = 0; x <= CONFIG.width; x += gridSize) {
        ctx.moveTo(x, 0); ctx.lineTo(x, CONFIG.height);
    }
    for (let y = 0; y <= CONFIG.height; y += gridSize) {
        ctx.moveTo(0, y); ctx.lineTo(CONFIG.width, y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;

    entities.particles.forEach(p => p.draw(ctx));
    
    if (gameState === 'PLAYING' || gameState === 'GAMEOVER') {
        entities.grenades.forEach(g => g.draw(ctx));
        entities.beams.forEach(b => b.draw(ctx));
        entities.bullets.forEach(b => b.draw(ctx));
        entities.enemies.forEach(e => e.draw(ctx));
        if (entities.player) entities.player.draw(ctx);
        
        // Joystick UI
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(CONFIG.joystickBase.x, CONFIG.joystickBase.y, CONFIG.joystickBase.r, 0, Math.PI*2);
        ctx.stroke();
        
        let stickX = CONFIG.joystickBase.x;
        let stickY = CONFIG.joystickBase.y;
        
        if (input.joystick.active) {
            stickX = input.joystick.currX;
            stickY = input.joystick.currY;
            ctx.strokeStyle = gameConfig.themeColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(CONFIG.joystickBase.x, CONFIG.joystickBase.y, CONFIG.joystickBase.r, 0, Math.PI*2);
            ctx.stroke();
        }

        ctx.fillStyle = input.joystick.active ? gameConfig.themeColor : 'rgba(255, 255, 255, 0.2)';
        ctx.beginPath();
        ctx.arc(stickX, stickY, 25, 0, Math.PI*2);
        ctx.fill();
        
        if (!input.joystick.active) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.font = '16px Teko';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('MOVE', CONFIG.joystickBase.x, CONFIG.joystickBase.y + 50);
        }
    }
}

/**
 * ยง Input System
 */
const canvas = document.getElementById('gameCanvas');

function handleGlobalInput(e) {
    if (e.target.tagName !== 'BUTTON' && e.target.id !== 'shoot-btn' && e.target.id !== 'ult-btn' && e.target.tagName !== 'INPUT') e.preventDefault();
    audioSys.unlock();
    
    if (gameState === 'LOBBY') {
        if (e.target.closest('#play-btn')) {
            audioSys.playSfx('sfx_play');
            restartGame();
        }
        if (e.target.closest('#settings-btn')) {
            audioSys.playSfx('sfx_ui_click');
            setState('SETTINGS');
        }
        if (e.target.closest('#ranking-btn')) {
            audioSys.playSfx('sfx_ui_click');
            setState('RANKING');
        }
        return;
    }

    if (gameState === 'SETTINGS') {
        if (e.target.closest('#settings-close')) {
            audioSys.playSfx('sfx_ui_click');
            setState('LOBBY');
        }
        return;
    }

    if (gameState === 'RANKING') {
        if (e.target.closest('#ranking-close')) {
            audioSys.playSfx('sfx_ui_click');
            setState('LOBBY');
        }
        return;
    }

    if (gameState === 'GAMEOVER') {
        if (e.target.id === 'restart-btn') restartGame();
        return;
    }

    if (gameState === 'PLAYING') {
          // Exit Button
        if (e.target.closest('#exit-btn')) {
            audioSys.playSfx('sfx_ui_click');
            setState('LOBBY');
            return;
        }

        // Ult Button
        if (e.target.closest('#ult-btn')) {
            if (e.type === 'pointerdown' || e.type === 'mousedown' || e.type === 'touchstart') {
                if (entities.player && entities.player.ultCharge >= 5) {
                    entities.player.fireBeam();
                }
            }
            return;
        }

        // Shoot Button
        if (e.target.closest('#shoot-btn')) {
            const btn = document.getElementById('shoot-btn');
            if (e.type === 'pointerdown' || e.type === 'mousedown' || e.type === 'touchstart') {
                input.shoot.active = true;
                btn.classList.add('btn-active');
            } else if (e.type === 'pointerup' || e.type === 'pointercancel' || e.type === 'mouseup' || e.type === 'touchend' || e.type === 'mouseout') {
                input.shoot.active = false;
                btn.classList.remove('btn-active');
            }
            return;
        }

        // Joystick Logic
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        const isRightHalf = x > CONFIG.width / 2;

        if ((e.type === 'pointerdown' || e.type === 'touchstart' || e.type === 'mousedown') && isRightHalf) {
            input.joystick.active = true;
            input.joystick.id = e.pointerId;
            input.joystick.startX = CONFIG.joystickBase.x;
            input.joystick.startY = CONFIG.joystickBase.y;
            input.joystick.currX = x;
            input.joystick.currY = y;
            
            const dx = x - input.joystick.startX;
            const dy = y - input.joystick.startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > CONFIG.joystickBase.r) {
                const angle = Math.atan2(dy, dx);
                input.joystick.currX = input.joystick.startX + Math.cos(angle) * CONFIG.joystickBase.r;
                input.joystick.currY = input.joystick.startY + Math.sin(angle) * CONFIG.joystickBase.r;
            }

            input.joystick.dx = (input.joystick.currX - input.joystick.startX) / CONFIG.joystickBase.r;
            input.joystick.dy = (input.joystick.currY - input.joystick.startY) / CONFIG.joystickBase.r;

        } else if ((e.type === 'pointermove' || e.type === 'touchmove' || e.type === 'mousemove') && input.joystick.active) {
            if (e.pointerId && e.pointerId !== input.joystick.id) return;

            const dx = x - input.joystick.startX;
            const dy = y - input.joystick.startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            const clampDist = Math.min(dist, CONFIG.joystickBase.r);
            const angle = Math.atan2(dy, dx);
            
            input.joystick.currX = input.joystick.startX + Math.cos(angle) * clampDist;
            input.joystick.currY = input.joystick.startY + Math.sin(angle) * clampDist;
            
            input.joystick.dx = Math.cos(angle) * (clampDist / CONFIG.joystickBase.r);
            input.joystick.dy = Math.sin(angle) * (clampDist / CONFIG.joystickBase.r);

        } else if (e.type === 'pointerup' || e.type === 'touchend' || e.type === 'mouseup' || e.type === 'pointercancel') {
            if (e.pointerId === input.joystick.id || !e.pointerId) {
                input.joystick.active = false;
                input.joystick.dx = 0;
                input.joystick.dy = 0;
                input.joystick.currX = CONFIG.joystickBase.x;
                input.joystick.currY = CONFIG.joystickBase.y;
            }
        }
    }
}

// Settings Event Listeners
  document.getElementById('input-brightness').addEventListener('input', (e) => {
    USER_SETTINGS.brightness = parseInt(e.target.value);
    updateSettingsUI();
    vibrate('light');
});

document.getElementById('input-sensitivity').addEventListener('input', (e) => {
    USER_SETTINGS.sensitivity = parseFloat(e.target.value);
    updateSettingsUI();
    vibrate('light');
});

document.getElementById('quality-low').addEventListener('click', () => {
    if (USER_SETTINGS.quality !== 'LOW') {
        USER_SETTINGS.quality = 'LOW';
        audioSys.playSfx('sfx_ui_toggle');
        updateSettingsUI();
    }
});

document.getElementById('quality-high').addEventListener('click', () => {
    if (USER_SETTINGS.quality !== 'HIGH') {
        USER_SETTINGS.quality = 'HIGH';
        audioSys.playSfx('sfx_ui_toggle');
        updateSettingsUI();
    }
});

['pointerdown', 'pointermove', 'pointerup', 'pointercancel'].forEach(evt => {
    window.addEventListener(evt, handleGlobalInput, { passive: false });
});

document.getElementById('play-btn').addEventListener('click', handleGlobalInput);
document.getElementById('settings-btn').addEventListener('click', handleGlobalInput);
document.getElementById('ranking-btn').addEventListener('click', handleGlobalInput);
document.getElementById('settings-close').addEventListener('click', handleGlobalInput);
document.getElementById('ranking-close').addEventListener('click', handleGlobalInput);
document.getElementById('restart-btn')?.addEventListener('click', (e) => {
    e.stopPropagation();
    audioSys.unlock();
    restartGame();
});

function resize() {
    const rect = document.getElementById('game-container').getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    
    canvas.width = width * CONFIG.dpr;
    canvas.height = height * CONFIG.dpr;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    
    CONFIG.width = width;
    CONFIG.height = height;
    CONFIG.cx = width / 2;
    CONFIG.cy = height / 2;
    
    CONFIG.joystickBase.x = width - 80; 
    CONFIG.joystickBase.y = height - 160;
    
    const ctx = canvas.getContext('2d');
    ctx.setTransform(CONFIG.dpr, 0, 0, CONFIG.dpr, 0, 0);
}

const ro = new ResizeObserver(entries =>
    for (const entry of entries) {
        resize();
        if (!initialized) initGame();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    ro.observe(document.getElementById('game-container'));
});
</script>

</body></html>
